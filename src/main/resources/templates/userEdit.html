<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Edit user</title>
    <link th:replace="fragments/general.html :: linkBootstrap"></link>
    <style type="text/css">
        body {
            padding: 50px;
        }

        label {
            display: inline-block;
            width: 100px;
        }

        input:read-only {
            background: lightgray;
        }

        .row {
            margin-top: 10px;
        }
    </style>
    <script th:replace="fragments/general.html :: scriptBootstrap"></script>
    <script>
        function saveUser() {
            const idInput = document.getElementById("id-input")
            const nameInput = document.getElementById("user-name-input")
            const passwordInput = document.getElementById("user-password-input")
            const emailInput = document.getElementById("user-email-input")
            const informAboutTasksInput = document.getElementById("user-informAboutTasks-input")


            var options = document.getElementById('user-products-input').selectedOptions;
            var products = Array.from(options).map(({ value }) => value);

            var options = document.getElementById('user-roles-input').selectedOptions;
            var roles = Array.from(options).map(({ value }) => value);


            const user = {id: idInput.value,
                            username: nameInput.value,
                            inputPassword: passwordInput.value,
                            email: emailInput.value,
                            informAboutTasks: informAboutTasksInput.checked,
                            products: products,
                            roles: roles}

            fetch("/api/users", {
                method: '[[${method}]]',
                headers: {
                  'Accept': 'application/json',
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify(user)})
            .then(response => {
                if (!response.ok) {
                    response.text().then(function (text) {
                        let diverror = document.getElementById(`diverror`)
                        diverror.innerHTML=text;
                    });
                    throw new Error('Network error');
                }
                document.location.href = '[[${redirectUrl}]]'
            })
        }


    </script>
</head>
<body>

<!-- Use edition -->
<form id="edit-form" th:object="${user}">
    <h3>User Info:</h3>

    <div class="row">
        <label for="id-input">ID:</label>
        <input id="id-input" type="text" readonly="readonly" value="1" th:value="*{id}" class="form-control"/>
    </div>

    <div class="row">
        <label for="user-name-input">User name:</label>
        <input id="user-name-input" name="username" type="text" value="John Doe" th:value="*{username}" class="form-control"/>
    </div>

    <div class="row">
        <label for="user-password-input">password:</label>
        <input id="user-password-input" name="password" type="password" value="" class="form-control"/>
    </div>

    <div class="row">
        <div class="col">
            <label for="user-email-input">User email:</label>
            <input id="user-email-input" name="email" type="text" value="John@mail.ru" th:value="*{email}" class="form-control"/>
        </div>
        <div class="col">
            <div class="form-check">
                <label for="user-informAboutTasks-input" class="form-check-label">Inform about tasks:</label>
                <input id="user-informAboutTasks-input" name="email" type="checkbox" value="false" th:checked="*{informAboutTasks}" class="form-check-input"/>
            </div>
        </div>
    </div>

    <div>
        Products:
        <select id="user-products-input" multiple="multiple" th:field="${user.products}" class="form-control">
            <option value="0">select products</option>
            <option th:each="product : ${products}" th:value="${product.id}" th:text="${product.name}" th:selected="${user.products.contains(product)}"></option>
        </select>
    </div>

    <div>
        Roles:
        <select id="user-roles-input" multiple="multiple" th:field="${user.roles}" class="form-control">
            <option value="0">select roles</option>
            <option th:each="role : ${roles}" th:value="${role.id}" th:text="${role.name}" th:selected="${user.roles.contains(role)}"></option>
        </select>
    </div>

    <div class="mb-3">
        <button type="button" onclick="saveUser()" class="btn btn-primary btn-lg">Save</button>
        <a href="userList.html" th:href="@{/users}"><button type="button" class="btn btn-secondary btn-lg">Cancel</button></a>
    </div>

    <div id="diverror"/>
</form>



<!--<pre id = "saved-author"></pre>-->

</body>
</html>
