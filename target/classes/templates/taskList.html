<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>List of all tasks</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <style type="text/css">
        body {
            padding: 50px;
        }

        .persons {
            border: 1px solid steelblue;
            width: 300px;
            border-collapse: collapse;
        }

        .persons tr td, th {
            padding: 5px;
            border: 1px solid steelblue;
        }

        .persons td:last-child, td:first-child {
            width: 50px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
    <script>


    function fillTable(tasks) {
        let strTBody = ``
        let tbody = document.getElementById(`tbody`)

        tasks.forEach(task=>{
            strTBody += `
                <tr>
                    <td>${task.id}</td>
                    <td>${task.created}</td>
                    <td>${task.name}</td>
                    <td>${task.product==null ? "" : task.product.name}</td>
                    <td>${task.taskType==null ? "" : task.taskType.name}</td>
                    <td>${task.priority}</td>
                    <td>${task.laborcosts}</td>
                    <td>${task.description}</td>
                    <td>${task.infoSystem==null ? "" : task.infoSystem.name}</td>
                    <td>${task.author==null ? "" : task.author.username}</td>
                    <td>${task.responsible==null ? "" : task.responsible.username}</td>
                    <td>${task.programmer==null ? "" : task.programmer.username}</td>
                    <td>${task.analyst==null ? "" : task.analyst.username}</td>

                    <td>
                        <a href="/tasks/edit/${task.id}">Edit</a>
                    </td>
                    <td>
                        <button class="deleteTask" onclick="deleteTask(${task.id})" class="btn btn-secondary btn-sm">DELETE</button>
                    </td>
                </tr>
            `})
        tbody.innerHTML=strTBody
    }

    function getAllTasks() {
        fetch("/api/tasks", {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
         })
        .then(response => response.json())
        .then(json => {fillTable(json)})
    }

  function deleteTask(id) {
        fetch("/api/tasks/"+id, {
            method: 'DELETE',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
         })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network error');
            }
            getAllTasks()
        })
    }

    </script>
</head>

<body onload="getAllTasks()">
<div th:replace="fragments/general.html :: navbar"></div>
<h3>Tasks:</h3>

<div>
    <div class="btn-group" role="group">
        <a href = "add.html" th:href = "@{/tasks/add}"><button type="button" class="btn btn-outline-primary">Add new</button></a>
        <!-- Кнопка-триггер модального окна -->
        <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
            Load tasks from Excel
        </button>
    </div>
</div>


<!-- Модальное окно -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Upload File Excel</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-8 mx-auto">
                        <p th:text="${message}" th:if="${message ne null}" class="alert alert-primary"></p>
                        <form method="post" th:action="@{/tasks/upload}" enctype="multipart/form-data">
                            <div class="form-group">
                                <input type="file" name="file" class="form-control-file">
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                                <button type="submit" class="btn btn-primary">Upload File</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<table class="table table-striped table-hover">
    <thead>
    <tr>
        <th>ID</th>
        <th>Created</th>
        <th>Name</th>
        <th>Product</th>
        <th>taskType</th>
        <th>Priority</th>
        <th>Laborcosts</th>
        <th>Description</th>
        <th>InfoSystem</th>
        <th>author</th>
        <th>responsible</th>
        <th>programmer</th>
        <th>analyst</th>
        <th>edit</th>
        <th>delete</th>
    </tr>
    </thead>
    <tbody id="tbody">
        <tr>
            <td colspan="9">
                <div class="d-flex justify-content-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                </div>
            </td>
        </tr>
    </tbody>
</table>
</body>
</html>
